{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import crypto from 'crypto';\nimport path from 'path';\nimport util from 'util';\nimport fs from 'fs';\n\nimport makeDir from 'make-dir';\nimport mime from 'mime';\nimport { createFilter } from '@rollup/pluginutils';\n\nconst fsStatPromise = util.promisify(fs.stat);\nconst fsReadFilePromise = util.promisify(fs.readFile);\nconst { posix, sep } = path;\nconst defaultInclude = ['**/*.svg', '**/*.png', '**/*.jp(e)?g', '**/*.gif', '**/*.webp'];\n\nexport default function url(options = {}) {\n  const {\n    limit = 14 * 1024,\n    include = defaultInclude,\n    exclude,\n    publicPath = '',\n    emitFiles = true,\n    fileName = '[hash][extname]'\n  } = options;\n  const filter = createFilter(include, exclude);\n\n  const copies = Object.create(null);\n\n  return {\n    name: 'url',\n    load(id) {\n      if (!filter(id)) {\n        return null;\n      }\n      return Promise.all([fsStatPromise(id), fsReadFilePromise(id)]).then(([stats, buffer]) => {\n        let data;\n        if ((limit && stats.size > limit) || limit === 0) {\n          const hash = crypto.createHash('sha1').update(buffer).digest('hex').substr(0, 16);\n          const ext = path.extname(id);\n          const name = path.basename(id, ext);\n          // Determine the directory name of the file based\n          // on either the relative path provided in options,\n          // or the parent directory\n          const relativeDir = options.sourceDir\n            ? path.relative(options.sourceDir, path.dirname(id))\n            : path.dirname(id).split(sep).pop();\n\n          // Generate the output file name based on some string\n          // replacement parameters\n          const outputFileName = fileName\n            .replace(/\\[hash\\]/g, hash)\n            .replace(/\\[extname\\]/g, ext)\n            // use `sep` for windows environments\n            .replace(/\\[dirname\\]/g, relativeDir === '' ? '' : `${relativeDir}${sep}`)\n            .replace(/\\[name\\]/g, name);\n          // Windows fix - exports must be in unix format\n          data = `${publicPath}${outputFileName.split(sep).join(posix.sep)}`;\n          copies[id] = outputFileName;\n        } else {\n          const mimetype = mime.getType(id);\n          const isSVG = mimetype === 'image/svg+xml';\n          data = isSVG ? encodeSVG(buffer) : buffer.toString('base64');\n          const encoding = isSVG ? '' : ';base64';\n          data = `data:${mimetype}${encoding},${data}`;\n        }\n        return `export default \"${data}\"`;\n      });\n    },\n    generateBundle: async function write(outputOptions) {\n      // Allow skipping saving files for server side builds.\n      if (!emitFiles) return;\n\n      const base = options.destDir || outputOptions.dir || path.dirname(outputOptions.file);\n\n      await makeDir(base);\n\n      await Promise.all(\n        Object.keys(copies).map(async (name) => {\n          const output = copies[name];\n          // Create a nested directory if the fileName pattern contains\n          // a directory structure\n          const outputDirectory = path.join(base, path.dirname(output));\n          await makeDir(outputDirectory);\n          return copy(name, path.join(base, output));\n        })\n      );\n    }\n  };\n}\n\nfunction copy(src, dest) {\n  return new Promise((resolve, reject) => {\n    const read = fs.createReadStream(src);\n    read.on('error', reject);\n    const write = fs.createWriteStream(dest);\n    write.on('error', reject);\n    write.on('finish', resolve);\n    read.pipe(write);\n  });\n}\n\n// https://github.com/filamentgroup/directory-encoder/blob/master/lib/svg-uri-encoder.js\nfunction encodeSVG(buffer) {\n  return (\n    encodeURIComponent(\n      buffer\n        .toString('utf-8')\n        // strip newlines and tabs\n        .replace(/[\\n\\r]/gim, '')\n        .replace(/\\t/gim, ' ')\n        // strip comments\n        .replace(/<!--(.*(?=-->))-->/gim, '')\n        // replace\n        .replace(/'/gim, '\\\\i')\n    )\n      // encode brackets\n      .replace(/\\(/g, '%28')\n      .replace(/\\)/g, '%29')\n  );\n}\n"],"names":["util","fs","path","createFilter","crypto","mime","makeDir"],"mappings":"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"}